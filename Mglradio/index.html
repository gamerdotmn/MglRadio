<html ng-app="mglradioapp">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
        <meta http-equiv="cache-control" content="max-age=0" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="pragma" content="no-cache" />
        <title>MGL RADIO</title>
        <!--css -->
        <link href="css/ionic.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/animate.css" rel="stylesheet">
        <link href="css/ionic.filter.bar.min.css" rel="stylesheet">
        <link href="css/swiper.min.css" rel="stylesheet">
        <link href="css/custom.css" rel="stylesheet">
        <!--js-->

        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/ionic.bundle.min.js"></script>
        <script type="text/javascript" src="js/swiper.js"></script>
        <script type="text/javascript" src="js/ionic.filter.bar.min.js"></script>
        <script type="text/javascript" src="js/moment.js"></script>
        <script type="text/javascript" src="js/angular-swiper.js"></script>
        <script type="text/javascript" src="js/app.js"></script>
        <script type="text/javascript">
            
            var my_media = null;
            var net = false;
            var isplaying = false;
            
            function play() {
                if (my_media===null) {
                    my_media = new Media("http://50.7.76.251:8080/;steam.mp3", 
                                         
                                         function () {
                                             
                                         },
                                         function (err) {
                                             
                                         }
                        ); 
                }
                my_media.play();
                MusicControls.updateIsPlaying(true);
                isplaying = true;
                try {
                document.getElementById("radiodiv").style.backgroundImage = "url(img/bar.gif)";
                }
                catch(err) {}
            }
            
            function pause() {
                my_media.pause();
                MusicControls.updateIsPlaying(false);
                isplaying = false;
                try {
                document.getElementById("radiodiv").style.backgroundImage = "";
                }
                catch(err) {}
            }
            
            function create_success() {
            }
            
            function create_error() {
            }            
            
            function onError() {
                navigator.notification.alert("Татахад алдаа гарлаа дахин оролдоно уу!", function(err){}, "Алдаа", "Хаах");
            }
            
            function events(action) {
                switch (action) {
                    case 'music-controls-pause':
                        pause();
                        break;
                    case 'music-controls-play':
                        play();
                        break;
                    default:
                        break;
                }
            }
            var db;
            var fileTransfer;
            var cdr;
            var download;
            var downloadstatus;
            var downloadanimate;
            
            function onFileSystemSuccess(fileSystem) {
                var entry = "";
                if (ionic.Platform.isAndroid()) {
                    entry = fileSystem;
                } else {
                    entry = fileSystem.root;
                }
                entry.getDirectory("MglRadio", {
                                       create: true,
                                       exclusive: false
                                   }, onGetDirectorySuccess, onError);
            }
            
            function onGetDirectorySuccess(dir) {
                cdr=dir;
                var filename = $rootScope.contentdetail.path.substring(download.path.lastIndexOf('/') + 1);
                dir.getFile(filename, {
                                create: true,
                                exclusive: false
                            }, gotFileEntry, onError);
                
            };
            
            function gotFileEntry() {
                var filename = download.path.substring(download.path.lastIndexOf('/') + 1);
                var documentUrl = download.path;
                var uri = encodeURI(documentUrl);
                
                fileTransfer.onprogress = function(progressEvent) {
                    if (progressEvent.lengthComputable) {
                        var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
                        downloadstatus = perc + "% татсан";
                    }
                };
                
                fileTransfer.download(uri, cdr.nativeURL + filename,
                                      function(entry) {
                                          downloadanimate = "slideOutDown";
                                          setTimeout(function(){downloadstatus="";}, 1000);
                                          cordova.plugins.notification.local.schedule({
                                                                                          title: "FM 102.1",
                                                                                          text: "Контент амжилттай татагдлаа.",
                                                                                          autoClear:  true
                                                                                      });
                                         
                                      },
                                      onError,
                                      false
                    );
            };
            
            function dodownload()
            {
                if (ionic.Platform.isAndroid()) {
                    window.resolveLocalFileSystemURL(cordova.file.externalRootDirectory, onFileSystemSuccess, onError);
                } else {
                    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccess, onError);
                }     
                
            }
            
            document.addEventListener('deviceready', function () {
                
                cordova.plugins.notification.local.on('click', function (notification) {
                    setTimeout(function(){document.location='#/app/radio';}, 2000);
                });
                
                if (navigator.onLine) {
                    net = true;
                }
                setInterval(function() { 
                    if (navigator.onLine) {
                        if (!net) {
                            net = true;
                            location.reload();
                        }
                    }
                }, 2500);
                
                if (typeof(MusicControls)!=="undefined") {
                    MusicControls.create({
                                             track       : 'FM 102.1',
                                             artist      : '',
                                             isPlaying   : false,
                                             dismissable : false,
                                             hasPrev   : false,
                                             hasNext   : false,
                                             hasClose  : false,
                                         }, create_success, create_error);
                    MusicControls.subscribe(events);
                    MusicControls.listen();
                }
                
                db = window.sqlitePlugin.openDatabase({name: "mglradio.db"});
                db.executeSql('DROP TABLE IF EXISTS content');
                db.executeSql('CREATE TABLE IF NOT EXISTS content (id integer primary key, name text, description text, path text, img text, type_id integer, time text)');
                fileTransfer = new FileTransfer();
            }, false);
            
            function searchval(val) {
                var $body = angular.element(document.body);            
                var $rootScope = $body.injector().get('$rootScope');   
                $rootScope.$apply(function () {                        
                    $rootScope.searchvalue = val;
                });
            }
        </script>
    </head>
    <body>
        <ion-nav-view></ion-nav-view>
    </body>
</html>